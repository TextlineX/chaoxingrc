# å·¥ä½œæµåç§°
name: android_build

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€ä»£ç åˆ° master æˆ– beta åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ "master", "beta" ]
    # å¿½ç•¥ Markdown æ–‡ä»¶å’Œ docs ç›®å½•çš„å˜æ›´ï¼ˆé¿å…ä¸å¿…è¦çš„æ„å»ºï¼‰
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  # å½“å‘ master æˆ– beta åˆ†æ”¯å‘èµ· Pull Request æ—¶è§¦å‘ï¼ˆç”¨äº CI æ£€æŸ¥ï¼‰
  pull_request:
    branches: [ "master", "beta" ]
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆç”¨äºç‰¹æ®Šæƒ…å†µä¸‹çš„å¼ºåˆ¶å‘å¸ƒï¼‰
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜ï¼ˆå¯é€‰ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶å¯å¡«å†™å˜æ›´å†…å®¹ï¼‰'
        required: false
        type: string

# ä»»åŠ¡å®šä¹‰
jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºä¸æµ‹è¯•
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Java ç¯å¢ƒï¼ˆFlutter Android æ„å»ºå¿…éœ€ï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: é…ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: flutter pub get

      - name: ä»£ç é™æ€åˆ†æ
        # ä½¿ç”¨ || true ç¡®ä¿å³ä½¿æœ‰è­¦å‘Šä¹Ÿä¸ä¼šä¸­æ–­æ„å»º
        run: flutter analyze || true

      - name: æ„å»ºå®‰è£…åŒ…
        run: |
          # æ ¹æ®å½“å‰åˆ†æ”¯é€‰æ‹©æ„å»ºç±»å‹
          if [[ "${{ github.ref_name }}" == "beta" ]]; then
            echo "æ­£åœ¨æ„å»º Beta ç‰ˆæœ¬ APK..."
            # ç”±äº build.gradle.kts å·²é…ç½® debug ç­¾åï¼Œè¿™é‡Œç›´æ¥æ„å»ºå³å¯
            flutter build apk --release
          else
            echo "æ­£åœ¨æ„å»ºæ­£å¼ç‰ˆæœ¬ APK å’Œ AAB..."
            # ç›´æ¥æ„å»ºï¼Œç­¾åç”± build.gradle.kts å¤„ç†
            flutter build apk --release
            flutter build appbundle --release
          fi

      - name: ä¸Šä¼ æ‰€æœ‰ APK æ–‡ä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error

      - name: ä¸Šä¼  AAB æ–‡ä»¶ï¼ˆä»…æ­£å¼ç‰ˆéœ€è¦ï¼‰
        if: github.ref_name != 'beta'
        uses: actions/upload-artifact@v4
        with:
          name: aab
          path: build/app/outputs/bundle/release/app-release.aab
          if-no-files-found: error

  # ç¬¬äºŒé˜¶æ®µï¼šåˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: build
    # è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€ æˆ– æ‰‹åŠ¨è§¦å‘
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆç”¨äºè¯»å– pubspec.yamlï¼‰
        uses: actions/checkout@v4

      - name: è·å–å½“å‰ç‰ˆæœ¬å·
        id: version
        run: |
          # ä» pubspec.yaml ä¸­æå–å®Œæ•´ç‰ˆæœ¬ï¼ˆå¯èƒ½åŒ…å« +buildï¼‰
          FULL_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | xargs)
          # å»æ‰ +build åŠå…¶åé¢çš„å†…å®¹ï¼Œåªä¿ç•™ x.y.z éƒ¨åˆ†ï¼ˆæ›´ç¾è§‚ï¼‰
          CLEAN_VERSION=$(echo $FULL_VERSION | sed 's/+.*//')
          # è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°ç‰ˆæœ¬ï¼š$CLEAN_VERSIONï¼ˆåŸå§‹ï¼š$FULL_VERSIONï¼‰"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»ºæ­£å¼ç‰ˆ Releaseï¼ˆmaster åˆ†æ”¯ï¼‰
        if: github.ref_name == 'master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.clean_version }}
          name: Release v${{ steps.version.outputs.clean_version }}
          body: |
            ## ğŸš€ æ­£å¼ç‰ˆå‘å¸ƒ v${{ steps.version.outputs.clean_version }}
            
            ${{ inputs.release_notes }}
            
            æ¥è‡ª master åˆ†æ”¯çš„è‡ªåŠ¨æ„å»ºã€‚
            
            ### ğŸ“¦ ä¸‹è½½
            - æ­£å¼ç‰ˆ APK
            - æ­£å¼ç‰ˆ AABï¼ˆç”¨äºä¸Šä¼  Google Playï¼‰
          files: |
            artifacts/apks/app-release.apk
            artifacts/aab/app-release.aab
          draft: false
          prerelease: false
          fail_on_unmatched_files: false

      - name: åˆ›å»º Beta ç‰ˆ Releaseï¼ˆbeta åˆ†æ”¯ï¼‰
        if: github.ref_name == 'beta'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.clean_version }}-beta
          name: Beta v${{ steps.version.outputs.clean_version }}
          body: |
            ## ğŸ§ª æµ‹è¯•ç‰ˆå‘å¸ƒ v${{ steps.version.outputs.clean_version }}
            
            ${{ inputs.release_notes }}
            
            æ¥è‡ª beta åˆ†æ”¯çš„è‡ªåŠ¨æ„å»ºã€‚
            
            ### ğŸ“¦ ä¸‹è½½
            - Beta ç‰ˆ APK
          files: |
            artifacts/apks/app-release.apk
          draft: false
          prerelease: true
          fail_on_unmatched_files: false
