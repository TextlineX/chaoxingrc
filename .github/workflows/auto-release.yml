name: Auto Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create release?'
        required: true
        default: 'yes'
        type: boolean
      version_suffix:
        description: 'Version suffix (optional)'
        required: false
        default: ''
        type: string

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ç”¨äºŽç‰ˆæœ¬å·ç”Ÿæˆ

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install dependencies
      run: flutter pub get

    - name: Generate version number
      id: version
      run: |
        # èŽ·å–å½“å‰æ—¶é—´æˆ³
        TIMESTAMP=$(date +'%Y%m%d-%H%M')

        # èŽ·å–æœ€è¿‘çš„commitæ•°é‡
        COMMIT_COUNT=$(git rev-list --count HEAD)

        # èŽ·å–å½“å‰åˆ†æ”¯å
        BRANCH=${GITHUB_REF#refs/heads/}

        # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è‡ªå®šä¹‰åŽç¼€ï¼Œä½¿ç”¨è‡ªå®šä¹‰åŽç¼€
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          SUFFIX="${{ github.event.inputs.version_suffix }}"
          if [ -n "$SUFFIX" ]; then
            VERSION="v1.0.$COMMIT_COUNT-$SUFFIX"
          else
            VERSION="v1.0.$COMMIT_COUNT-$TIMESTAMP"
          fi
        else
          # è‡ªåŠ¨è§¦å‘æ—¶ä½¿ç”¨æ—¶é—´æˆ³
          VERSION="v1.0.$COMMIT_COUNT-$TIMESTAMP"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"

    - name: Build APK
      run: |
        flutter clean
        flutter pub get
        flutter build apk --release --no-shrink

    - name: Build App Bundle
      run: |
        flutter build appbundle --release --no-shrink

    - name: Generate Release Notes
      id: release_notes
      run: |
        # èŽ·å–æœ€è¿‘ä¸€æ¬¡commitçš„ä¿¡æ¯
        LAST_COMMIT=$(git log -1 --pretty=format:"%h %s")
        COMMITS_SINCE_RELEASE=$(git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo HEAD~10)..HEAD)

        cat > release_notes.md << EOF
        ## ðŸ“± è¶…æ˜Ÿå­¦ä¹ é€šç½‘ç›˜ - è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬

        **ç‰ˆæœ¬ä¿¡æ¯ï¼š** ${{ steps.version.outputs.version }}
        **æž„å»ºæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
        **åˆ†æ”¯ï¼š** ${GITHUB_REF#refs/heads/}

        ### ðŸ”„ æœ¬æ¬¡æ›´æ–°å†…å®¹
        $COMMITS_SINCE_RELEASE

        ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
        - **APKæ–‡ä»¶**: ç›´æŽ¥å®‰è£…çš„Androidåº”ç”¨åŒ…
        - **AABæ–‡ä»¶**: Google Playå•†åº—å‘å¸ƒåŒ…

        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
        - å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å°è¯•å¸è½½æ—§ç‰ˆæœ¬åŽé‡æ–°å®‰è£…

        ---
        ðŸ¤– *æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ*
        EOF

        echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "è¶…æ˜Ÿå­¦ä¹ é€šç½‘ç›˜ ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        files: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifacts to Actions
      uses: actions/upload-artifact@v4
      with:
        name: chaoxingrc-${{ steps.version.outputs.version }}
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
        retention-days: 30

    - name: Notify Success
      run: |
        echo "âœ… Release ${{ steps.version.outputs.version }} created successfully!"
        echo "ðŸ“± APK Size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
        echo "ðŸ“¦ AAB Size: $(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)"