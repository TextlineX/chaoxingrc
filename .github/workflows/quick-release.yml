name: Quick Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (optional)'
        required: false
        default: ''
        type: string
      prerelease:
        description: 'Mark as prerelease?'
        required: true
        default: 'false'
        type: boolean

jobs:
  quick-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install dependencies
      run: |
        flutter pub get
        flutter clean

    - name: Get version from tag
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬å·
          VERSION="v$(date +'%Y%m%d-%H%M')-quick"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Build APK (optimized)
      run: |
        flutter build apk --release \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/debug-info/

    - name: Build App Bundle (optimized)
      run: |
        flutter build appbundle --release \
          --obfuscate \
          --split-debug-info=build/debug-info/

    - name: Package debug info
      run: |
        cd build/debug-info/
        tar -czf ../debug-info.tar.gz .
        cd ../..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ${{ github.event.inputs.release_name || format('Release {0}', steps.version.outputs.version) }}
        body: |
          ## ğŸš€ å¿«é€Ÿå‘å¸ƒç‰ˆæœ¬

          **ç‰ˆæœ¬ï¼š** `${{ steps.version.outputs.version }}`
          **æ„å»ºæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S UTC')

          ### ğŸ“± ä¸‹è½½æ–‡ä»¶

          **APKæ–‡ä»¶ (æ¨è):**
          - `app-arm64-v8a-release.apk` - 64ä½ARMè®¾å¤‡ (å¤§å¤šæ•°ç°ä»£Androidè®¾å¤‡)
          - `app-armeabi-v7a-release.apk` - 32ä½ARMè®¾å¤‡ (è¾ƒè€çš„Androidè®¾å¤‡)
          - `app-x86_64-release.apk` - 64ä½x86è®¾å¤‡ (æ¨¡æ‹Ÿå™¨/å¹³æ¿)

          **å…¶ä»–æ–‡ä»¶:**
          - `app-release.aab` - Google Playå•†åº—å‘å¸ƒåŒ…
          - `debug-info.tar.gz` - è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ (ç”¨äºcrashåˆ†æ)

          ### âš¡ å¿«é€Ÿå®‰è£…æŒ‡å—
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„APKæ–‡ä»¶
          2. å…è®¸"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…

          ---
          ğŸ¤– *æ­¤ç‰ˆæœ¬ç”±GitHub Actionså¿«é€Ÿå‘å¸ƒ*
        files: |
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-x86_64-release.apk
          build/app/outputs/bundle/release/app-release.aab
          build/debug-info.tar.gz
        draft: false
        prerelease: ${{ github.event.inputs.prerelease || 'false' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Release Info
      run: |
        echo "âœ… Quick release completed!"
        echo "ğŸ“Š Release info:"
        echo "  - Version: ${{ steps.version.outputs.version }}"
        echo "  - Assets: $(find build/app/outputs -name "*.apk" -o -name "*.aab" | wc -l) files"
        echo "  - Total size: $(du -sh build/app/outputs/flutter-apk/ build/app/outputs/bundle/ | awk '{sum+=$1} END {print sum "B"}')"